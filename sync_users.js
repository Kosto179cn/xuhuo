const { chromium } = require('playwright');
const axios = require('axios');
const fs = require('fs');
const path = require('path');

// å›ºå®šé…ç½®
const CONFIG = {
  GITEE_API_URL: 'https://gitee.com/api/v5/repos/Kosto179/kosto-battle-clicker-new/contents/douyinh.txt',
  LOCAL_USERS_FILE: 'users.txt',
  CREATOR_CHAT_URL: 'https://creator.douyin.com/creator-micro/data/following/chat',
  GOTO_TIMEOUT: 120000,
  MAX_SCROLL_ATTEMPTS: 150, // åŠ å¤§æœ€å¤§è½®æ¬¡ï¼Œç¡®ä¿æ‰«å®Œé•¿åˆ—è¡¨
  SCROLL_TOTAL_STEP: 600,   // å‡å°æ­¥é•¿ï¼Œé¿å…è·³è¿‡ç”¨æˆ·
  SCROLL_STEP: 100,
  MAX_NO_NEW_USER_COUNT: 8   // æ”¾å®½ç»ˆæ­¢æ¡ä»¶ï¼Œ8è½®æ— æ–°ç”¨æˆ·æ‰åœæ­¢
};

// æ—¥å¿—å‡½æ•°
const log = (level, msg, ...args) => console.log(`[${new Date().toLocaleTimeString()}] [${level.toUpperCase()}] ${msg}`, ...args);

// ä¸»å‡½æ•°
async function runSync() {
  let browser = null;
  let page = null;
  try {
    log('info', 'ğŸš€ å¯åŠ¨æŠ–éŸ³ç”¨æˆ·åŒæ­¥è„šæœ¬ï¼ˆæ»šåŠ¨å…¨é‡ä¿®å¤ç‰ˆï¼‰');

    // ========== 1. ç¯å¢ƒå˜é‡æ ¡éªŒ ==========
    const giteeToken = process.env.GITEE_TOKEN?.trim();
    const douyinCookies = process.env.DOUYIN_COOKIES?.trim();
    if (!giteeToken) {
      log('error', 'âŒ æœªè¯»å–åˆ°GITEE_TOKENï¼Œè¯·æ£€æŸ¥GitHub Secretsé…ç½®');
      process.exit(1);
    }
    if (!douyinCookies) {
      log('error', 'âŒ æœªè¯»å–åˆ°DOUYIN_COOKIESï¼Œè¯·æ£€æŸ¥GitHub Secretsé…ç½®');
      process.exit(1);
    }
    log('success', `âœ… ç¯å¢ƒå˜é‡è¯»å–å®Œæˆï¼ŒGitee Tokené•¿åº¦: ${giteeToken.length}`);

    // ========== 2. ä»Giteeæ‹‰å–ç›®æ ‡æŠ–éŸ³å·åˆ—è¡¨ ==========
    log('info', 'ğŸ“¥ æ­£åœ¨ä»Giteeæ‹‰å–ç›®æ ‡æŠ–éŸ³å·åˆ—è¡¨');
    const giteeRes = await axios.get(CONFIG.GITEE_API_URL, {
      params: { access_token: giteeToken },
      headers: { 'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0.0.0 Safari/537.36' },
      timeout: 30000
    }).catch(err => {
      if (err.response) {
        log('error', `âŒ Gitee APIè¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç : ${err.response.status}`);
        err.response.status === 401 && log('error', '   åŸå› ï¼šGitee Tokenæ— æ•ˆæˆ–æ— ä»“åº“æƒé™');
        err.response.status === 404 && log('error', '   åŸå› ï¼šä»“åº“/æ–‡ä»¶è·¯å¾„ä¸å­˜åœ¨');
      } else {
        log('error', `âŒ Gitee APIç½‘ç»œè¯·æ±‚å¤±è´¥: ${err.message}`);
      }
      process.exit(1);
    });

    const rawFileContent = Buffer.from(giteeRes.data.content, 'base64').toString();
    const TARGET_DOUYIN_IDS = rawFileContent.split('\n')
      .map(id => id.trim())
      .filter(id => id && !id.startsWith('#'));

    if (TARGET_DOUYIN_IDS.length === 0) {
      log('error', 'âŒ ä»Giteeæ‹‰å–çš„æŠ–éŸ³å·åˆ—è¡¨ä¸ºç©º');
      process.exit(1);
    }
    log('success', `âœ… æˆåŠŸæ‹‰å–åˆ°${TARGET_DOUYIN_IDS.length}ä¸ªç›®æ ‡æŠ–éŸ³å·`);

    // ========== 3. å¯åŠ¨æµè§ˆå™¨ï¼Œæ³¨å…¥Cookie ==========
    log('info', 'ğŸŒ æ­£åœ¨å¯åŠ¨æ— å¤´æµè§ˆå™¨');
    browser = await chromium.launch({
      headless: true,
      args: [
        '--no-sandbox',
        '--disable-setuid-sandbox',
        '--disable-dev-shm-usage',
        '--disable-gpu',
        '--disable-blink-features=AutomationControlled',
        '--disable-background-timer-throttling',
        '--disable-backgrounding-occluded-windows',
        '--disable-renderer-backgrounding'
      ]
    });

    const context = await browser.newContext({
      viewport: { width: 1920, height: 1080 },
      userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0.0.0 Safari/537.36',
      ignoreHTTPSErrors: true,
      javaScriptEnabled: true
    });

    await context.addInitScript(() => {
      Object.defineProperty(navigator, 'webdriver', { get: () => undefined });
      Object.defineProperty(navigator, 'plugins', { get: () => [1, 2, 3, 4, 5] });
      Object.defineProperty(navigator, 'languages', { get: () => ['zh-CN', 'zh'] });
      window.chrome = { runtime: {} };
    });

    let parsedCookies;
    try {
      parsedCookies = JSON.parse(douyinCookies);
    } catch (err) {
      log('error', 'âŒ DOUYIN_COOKIESæ ¼å¼é”™è¯¯ï¼Œå¿…é¡»æ˜¯æ ‡å‡†JSONå­—ç¬¦ä¸²');
      process.exit(1);
    }

    const fixCookies = (rawCookies) => {
      return rawCookies.map(cookie => {
        if (cookie.sameSite) {
          const ss = cookie.sameSite.toLowerCase();
          if (ss === 'lax') cookie.sameSite = 'Lax';
          else if (ss === 'strict') cookie.sameSite = 'Strict';
          else if (ss === 'none') cookie.sameSite = 'None';
          else delete cookie.sameSite;
        } else {
          delete cookie.sameSite;
        }
        delete cookie.storeId;
        delete cookie.hostOnly;
        delete cookie.session;
        return cookie;
      });
    };
    const cleanCookies = fixCookies(parsedCookies);
    await context.addCookies(cleanCookies);

    page = await context.newPage();
    page.on('pageerror', err => log('error', `é¡µé¢è¿è¡Œé”™è¯¯: ${err.message}`));
    log('success', 'âœ… æµè§ˆå™¨å¯åŠ¨å®Œæˆï¼ŒCookieå·²æ³¨å…¥');

    // ========== 4. é¡µé¢åŠ è½½ ==========
    log('info', 'ğŸŒ æ­£åœ¨è¿›å…¥æŠ–éŸ³åˆ›ä½œè€…ä¸­å¿ƒç§ä¿¡é¡µé¢ï¼Œç­‰å¾…é¡µé¢åŠ è½½...');
    await page.goto(CONFIG.CREATOR_CHAT_URL, {
      waitUntil: 'domcontentloaded',
      timeout: CONFIG.GOTO_TIMEOUT
    });

    await page.waitForTimeout(10000);
    const currentUrl = page.url();
    if (currentUrl.includes('login') || currentUrl.includes('passport') || currentUrl.includes('verify')) {
      log('error', 'âŒ Cookieå·²