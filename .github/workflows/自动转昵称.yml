name: ğŸ”— GiteeåŒæ­¥ - æŠ–éŸ³IDè½¬æ˜µç§°

on:
  schedule:
    # æ ¸å¿ƒé…ç½®ï¼šæ¯å°æ—¶æ‰§è¡Œä¸€æ¬¡ï¼ˆUTCæ—¶é—´æ¯å°æ—¶0åˆ†ï¼Œå¯¹åº”åŒ—äº¬æ—¶é—´æ¯å°æ—¶8åˆ†ï¼Œé—´éš”å›ºå®š60åˆ†é’Ÿï¼Œå®Œå…¨æ»¡è¶³æ¯å°æ—¶è·‘ä¸€æ¬¡çš„éœ€æ±‚ï¼‰
    # å¦‚æœä½ éœ€è¦ã€åŒ—äº¬æ—¶é—´æ¯å°æ—¶0åˆ†å‡†ç‚¹æ‰§è¡Œã€‘ï¼ŒæŠŠä¸‹é¢è¿™è¡Œæ³¨é‡Šï¼Œç”¨ä¸‹é¢å¤‡é€‰çš„cron
    - cron: '0 * * * *'
    # å¤‡é€‰ï¼šåŒ—äº¬æ—¶é—´æ¯å°æ—¶0åˆ†å‡†ç‚¹æ‰§è¡Œï¼ˆUTCæ—¶é—´=åŒ—äº¬æ—¶é—´-8å°æ—¶ï¼Œé€‚é…24å°æ—¶ï¼‰
    # - cron: '0 16,17,18,19,20,21,22,23,0,1,2,3,4,5,6,7 * * *'
  workflow_dispatch:
    inputs:
      mode:
        description: 'è¿è¡Œæ¨¡å¼'
        required: true
        default: 'sync'
        type: choice
        options:
          - sync
          - debug
  push:
    branches:
      - main
      - master
    paths:
      - 'sync_users.js'
      - '.github/workflows/è‡ªåŠ¨è½¬æ˜µç§°.yml'

# å¿…é¡»é…ç½®ï¼šä»“åº“å†™å…¥æƒé™ï¼Œè§£å†³git pushå¤±è´¥é—®é¢˜
permissions:
  contents: write

jobs:
  sync-users:
    runs-on: ubuntu-latest
    name: åŒæ­¥GiteeæŠ–éŸ³å·
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“¦ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: âš™ï¸ å®‰è£…ä¾èµ–
        run: |
          npm install axios playwright
          # ä¿®å¤æµè§ˆå™¨ä¾èµ–ç¼ºå¤±é—®é¢˜ï¼Œå¿…é¡»åŠ --with-deps
          npx playwright install chromium --with-deps

      - name: ğŸ” æ‰§è¡ŒåŒæ­¥è„šæœ¬
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          DOUYIN_COOKIES: ${{ secrets.DOUYIN_COOKIES }}
          DEBUG: ${{ inputs.mode == 'debug' && '*' || '' }}
        run: |
          node sync_users.js
        shell: bash

      - name: ğŸ“¤ æ¨é€æ›´æ–° (å¦‚æœusers.txtæœ‰å˜åŒ–)
        id: git_commit
        if: always()
        run: |
          if git diff --exit-code users.txt > /dev/null; then
            echo "âœ… users.txt æ— å˜åŒ–ï¼Œæ— éœ€æäº¤"
            echo "NO_CHANGES=false" >> $GITHUB_ENV
          else
            echo "ğŸ”„ users.txt æœ‰å˜åŒ–ï¼Œæ­£åœ¨æäº¤æ›´æ–°"
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add users.txt
            git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–° users.txt $(date +'%Y-%m-%d %H:%M')"
            git push
            echo "NO_CHANGES=true" >> $GITHUB_ENV
          fi
        shell: bash

      - name: ğŸ“ åŒæ­¥æˆåŠŸé€šçŸ¥
        if: env.NO_CHANGES == 'true'
        run: |
          echo "âœ… å·²æˆåŠŸåŒæ­¥GiteeæŠ–éŸ³å·ï¼Œæ›´æ–°users.txtæ–‡ä»¶"
        shell: bash

      - name: âŒ æ‰§è¡Œå¤±è´¥é€šçŸ¥
        if: failure()
        run: |
          echo "âŒ åŒæ­¥è„šæœ¬æ‰§è¡Œå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—æ’æŸ¥é—®é¢˜"
        shell: bash
