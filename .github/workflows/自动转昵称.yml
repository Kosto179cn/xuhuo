name: ğŸ”— GiteeåŒæ­¥ - æŠ–éŸ³IDè½¬æ˜µç§°

on:
  schedule:
    # æ¯å°æ—¶æ‰§è¡Œä¸€æ¬¡
    - cron: '0 * * * *'
  workflow_dispatch:
    inputs:
      mode:
        description: 'è¿è¡Œæ¨¡å¼'
        required: true
        default: 'sync'
        type: choice
        options:
          - sync
          - debug
  push:
    branches:
      - main
      - master
    paths:
      - 'sync_users.js'
      - '.github/workflows/è‡ªåŠ¨è½¬æ˜µç§°.yml'

# ä»“åº“å†™å…¥æƒé™ï¼Œè§£å†³git pushå¤±è´¥é—®é¢˜
permissions:
  contents: write

jobs:
  sync-users:
    runs-on: ubuntu-latest
    name: åŒæ­¥GiteeæŠ–éŸ³å·
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“¦ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          # å·²åˆ é™¤cache: npmï¼Œå½»åº•è§£å†³é”æ–‡ä»¶æŠ¥é”™

      - name: âš™ï¸ å®‰è£…ä¾èµ–
        run: |
          npm install axios playwright
          # å®‰è£…ChromiumåŠç³»ç»Ÿä¾èµ–ï¼Œè§£å†³æµè§ˆå™¨å¯åŠ¨å¤±è´¥
          npx playwright install chromium --with-deps

      - name: ğŸ” æ‰§è¡ŒåŒæ­¥è„šæœ¬
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          DOUYIN_COOKIES: ${{ secrets.DOUYIN_COOKIES }}
          DEBUG: ${{ inputs.mode == 'debug' && '*' || '' }}
        run: |
          node sync_users.js
        shell: bash

      - name: ğŸ“¤ æ¨é€æ›´æ–° (å¦‚æœusers.txtæœ‰å˜åŒ–)
        id: git_commit
        if: always()
        run: |
          if git diff --exit-code users.txt > /dev/null; then
            echo "âœ… users.txt æ— å˜åŒ–ï¼Œæ— éœ€æäº¤"
            echo "NO_CHANGES=false" >> $GITHUB_ENV
          else
            echo "ğŸ”„ users.txt æœ‰å˜åŒ–ï¼Œæ­£åœ¨æäº¤æ›´æ–°"
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add users.txt
            git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–° users.txt $(date +'%Y-%m-%d %H:%M')"
            git push
            echo "NO_CHANGES=true" >> $GITHUB_ENV
          fi
        shell: bash

      - name: ğŸ“ åŒæ­¥æˆåŠŸé€šçŸ¥
        if: env.NO_CHANGES == 'true'
        run: |
          echo "âœ… å·²æˆåŠŸåŒæ­¥GiteeæŠ–éŸ³å·ï¼Œæ›´æ–°users.txtæ–‡ä»¶"
        shell: bash

      - name: âŒ æ‰§è¡Œå¤±è´¥é€šçŸ¥
        if: failure()
        run: |
          echo "âŒ åŒæ­¥è„šæœ¬æ‰§è¡Œå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—æ’æŸ¥é—®é¢˜"
        shell: bash
