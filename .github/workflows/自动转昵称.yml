name: ğŸ”— GiteeåŒæ­¥ - æŠ–éŸ³IDè½¬æ˜µç§°

# ä¸‰ç§è§¦å‘æ–¹å¼ï¼š
# 1. æ‰‹åŠ¨è§¦å‘ (workflow_dispatch)
# 2. å®šæ—¶ä»»åŠ¡ (ä¾‹å¦‚æ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡Giteeæ˜¯å¦æœ‰æ›´æ–°)
# 3. å½“Giteeæ–‡ä»¶æ›´æ–°æ—¶è§¦å‘ (éœ€è¦Gitee Webhookï¼Œæ­¤å¤„æœªé…ç½®ï¼Œä»¥å®šæ—¶ä¸ºä¸»)
on:
  schedule:
    # æ¯å¤©æ—©ä¸Š 8ç‚¹ å’Œ æ™šä¸Š 8ç‚¹ æ£€æŸ¥æ›´æ–° (åŒ—äº¬æ—¶é—´éœ€+8å°æ—¶)
    - cron: '0 0,12 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨ç‚¹å‡»è¿è¡Œ
    inputs:
      mode:
        description: 'è¿è¡Œæ¨¡å¼'
        required: true
        default: 'sync'
        type: choice
        options:
          - sync
          - debug

jobs:
  sync-users:
    runs-on: ubuntu-latest
    name: åŒæ­¥GiteeæŠ–éŸ³å·
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“¦ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: âš™ï¸ å®‰è£…ä¾èµ–
        run: |
          npm install axios playwright
          npx playwright install chromium

      - name: ğŸ” æ‰§è¡ŒåŒæ­¥è„šæœ¬
        env:
          # è¿™é‡Œéœ€è¦ä¸¤ä¸ªå¯†é’¥ï¼šä¸€ä¸ªç»™Giteeï¼Œä¸€ä¸ªç»™æŠ–éŸ³
          GITEE_TOKEN: $
          DOUYIN_COOKIES: $
        run: |
          # å¯ç”¨æ ¸å¿ƒè½¬å‚¨æˆ–è°ƒè¯•æ—¥å¿—ï¼ˆå¦‚æœéœ€è¦ï¼‰
          # å¦‚æœè„šæœ¬æŠ¥é”™ï¼Œå¯ä»¥åœ¨è¿™é‡ŒåŠ  DEBUG=* æ¥æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
          node sync_users.js

      - name: ğŸ“¤ æ¨é€æ›´æ–° (å¦‚æœusers.txtæœ‰å˜åŒ–)
        id: git_commit
        run: |
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æœ‰å˜åŒ–
          if git diff --exit-code users.txt > /dev/null; then
            echo "NO_CHANGES=false" >> $GITHUB_ENV
          else
            echo "NO_CHANGES=true"
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add users.txt
            git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–° users.txt $(date)"
            git push
          fi

      - name: ğŸ“ å‘é€é€šçŸ¥ (å¯é€‰)
        if: env.NO_CHANGES == 'true'
        run: |
          echo " å·±æ£€æµ‹åˆ°Giteeåˆ—è¡¨æ›´æ–°å¹¶åŒæ­¥äº† users.txt"
        # è¿™é‡Œå¯ä»¥æ¥å…¥ Serveré…± æˆ– Bark ç­‰æ¨é€æœåŠ¡ï¼Œå‘ŠçŸ¥ä½ åˆ—è¡¨å·²æ›´æ–°
